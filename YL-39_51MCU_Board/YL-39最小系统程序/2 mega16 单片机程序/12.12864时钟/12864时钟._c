  /******************************************************************************/
/*【编写时间】： 2011.07.07
* 【作    者】： 雁翎电子
* 【版    本】： V1.0
* 【网    站】： http://ylelectronic.taobao.com/ 
* 【Q      Q】： 348439350
* 【编译环境】： ICCAVR  
* 【函数功能】： 12864 时钟显示 
* 【晶    振】:  8M		
* 【芯    片】:  ATMEGA16A	 
* 【硬件连接】： J2短路帽拿掉   
/******************************************************************************/
#include <iom16v.h>
#include <macros.h>
#define Set_Bit(val, bitn)    (val |=(1<<(bitn))) 
#define Clr_Bit(val, bitn)    (val&=~(1<<(bitn))) 
//12864
void Write_char(unsigned char start, unsigned char ddata);
void Send_byte (unsigned char bbyte);
void Delaynms  (unsigned int di);
void Lcd_init  (void);
void delay     (void);
void Disp_img  (unsigned char const *img);
void timer1_init(void);
unsigned char  Sec,Min,Hour=0;
unsigned char  flag=0;
unsigned char  disbuf[6]={0,0,0,0,0,0};
unsigned char  num[]=    {"0123456789: "};
unsigned char  welcome[]={"时间:"};
unsigned char  input[]  ={"日期:"};
const unsigned char  discode[10]={ 0xC0, 0xF9,0xA4,0xB0,0x99,0x92,0x82,0xF8,0x80,0x90 }; 
/**************************************************************/
 unsigned  char const logo[]={  
/*--  调入了一幅图像：C:\Documents and Settings\lwd\桌面\AVR程序\AVR_12864_串行\b01.bmp  --*/
/*--  宽度x高度=127x63  --*/
/*--  宽度不是8的倍数，现调整为：宽度x高度=128x63  --*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0xF3,0xE0,0x0F,0x8F,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0xF3,0xF0,0x0F,0x8F,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x07,0xF9,0xF0,0x0F,0x9F,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x07,0xF9,0xF8,0x1F,0x9F,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x07,0xF9,0xF8,0x1F,0x1F,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x0F,0xFC,0xF8,0x1F,0x3F,0x1F,0x80,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFC,0x00,
0x00,0x0F,0xFC,0xFC,0x3F,0x3F,0x1F,0x80,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFC,0x00,
0x00,0x0F,0xFC,0x7C,0x3E,0x3E,0x1F,0x80,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFC,0x00,
0x00,0x1F,0xFE,0x7C,0x7E,0x7E,0x3F,0x00,0x20,0x00,0x00,0x01,0xC0,0x00,0x00,0x00,
0x00,0x1F,0xBE,0x7E,0x7E,0x7E,0xFF,0x00,0x70,0x00,0x00,0x0D,0xBF,0xDF,0xB0,0x00,
0x00,0x1F,0x3E,0x3E,0x7C,0x7F,0xFF,0x00,0x70,0x00,0x00,0x1D,0xFF,0xDF,0xB0,0x00,
0x00,0x3F,0x3F,0x3E,0x7C,0xFF,0xFE,0x00,0x70,0x00,0x00,0x1D,0xFF,0xD8,0x30,0x00,
0x00,0x3F,0x1F,0x3F,0xFC,0xFF,0xFC,0x00,0x60,0x00,0x00,0x3D,0xF6,0xD8,0x30,0x00,
0x00,0x3F,0x1F,0x9F,0xF8,0xFF,0xF0,0x00,0xE0,0x00,0x00,0x3D,0xF6,0xDF,0xB0,0x00,
0x00,0x3F,0xFF,0x9F,0xF9,0xFF,0xE0,0x00,0xC0,0x00,0x00,0x7D,0xF6,0xDF,0xB0,0x00,
0x00,0x7F,0xFF,0x9F,0xF9,0xFB,0xE0,0x00,0x40,0x00,0x00,0xED,0xF6,0xD8,0x30,0x00,
0x00,0x7F,0xFF,0xCF,0xF1,0xF3,0xF0,0x00,0x40,0x00,0x00,0xED,0xF6,0xD8,0x30,0x00,
0x00,0x7F,0xFF,0xCF,0xF3,0xF3,0xF0,0x00,0x40,0x00,0x00,0xED,0xF6,0xDF,0xB0,0x00,
0x00,0xFF,0xFF,0xCF,0xF3,0xF1,0xF0,0x00,0x60,0x00,0x01,0xFF,0xFF,0xFF,0xFE,0x00,
0x00,0xF8,0x07,0xE7,0xE3,0xE1,0xF0,0x08,0x20,0x1E,0x01,0xFF,0xFF,0xFF,0xFE,0x00,
0x00,0xF8,0x03,0xE7,0xE7,0xE1,0xF8,0xFF,0x3C,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xF8,0x03,0xE3,0xE7,0xE1,0xF9,0xFF,0xFF,0xF7,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0xF0,0x01,0xE3,0xC7,0xC0,0xF9,0xE0,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0xC0,0x00,0x00,0x80,0x7C,0xFC,0xC0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xC0,0x00,0x00,0x00,0x7F,0xFC,0xF0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x7F,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x27,0xFF,0xB0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x37,0xFF,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0x1C,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0x0C,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xDF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x1F,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xBF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x01,0xF8,0x3C,0x00,0xCC,0x00,0x00,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x1F,0x6C,0x37,0xF1,0x8C,0x00,0x00,0xE7,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0x60,0x6F,0x37,0xFF,0x80,0x00,0xCF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x1F,0xFE,0x6C,0x36,0x79,0x80,0x00,0xEE,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0x60,0xEC,0x36,0x71,0x80,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0xEC,0x6C,0x36,0x79,0x80,0x00,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x07,0xF8,0x6C,0x37,0xED,0x80,0x00,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x1F,0x30,0x6C,0x36,0x6D,0x80,0x00,0x76,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0x76,0x6C,0x36,0x61,0x80,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0xDE,0x6C,0x37,0xE1,0x80,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x0F,0x0E,0x6C,0xF6,0x6F,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

/******************************************************************************/
void Lcd_init(void)	//初始化LCD 
{
	Delaynms(10); //启动等待，等LCM讲入工作状态
	Set_Bit(PORTA,0);
  	Write_char(0,0x30);  //8 位介面，基本指令集
	Delaynms(10);
  	Write_char(0,0x0c);  //显示打开，光标关，反白关
	Delaynms(10);
  	Write_char(0,0x01);  //清屏，将DDRAM的地址计数器归零  
	Delaynms(10);
}

/******************************************************************************/
void Write_char(unsigned char start, unsigned char ddata) //写指令或数据
{
	unsigned char start_data,Hdata,Ldata;
  	if(start==0) 
		start_data=0xf8;	 //写指令
    else    
    	start_data=0xfa;  //写数据
  
  	Hdata=ddata&0xf0;		  //取高四位
  	Ldata=(ddata<<4)&0xf0;  //取低四位
  	Send_byte(start_data);	  //发送起始信号
  	Delaynms(10); //延时是必须的
  	Send_byte(Hdata);	      //发送高四位
  	Delaynms(10);  //延时是必须的
  	Send_byte(Ldata);		  //发送低四位
  	Delaynms(10);  //延时是必须的
}

/******************************************************************************/
void Send_byte(unsigned char bbyte) //发送一个字节
{
    unsigned char i,j;
 	for(i=0;i<8;i++)
   	{    
   		j=bbyte&0x80; //取出最高位
 		if(j)
			Set_Bit(PORTA,1);
		else
			Clr_Bit(PORTA,1);
		Set_Bit(PORTA,2);
		//Delaynms(1);
		Clr_Bit(PORTA,2);
   		bbyte<<=1; //左移  
   	}  
}

/******************************************************************************/
void Delaynms(unsigned int di) //延时
{
	unsigned int da,db;
 	for(da=0;da<di;da++)
   		for(db=0;db<10;db++);
}

/****************************************************************************/
void Disp_img(unsigned char const *img )	//图形方式12864显示字模221 横向取膜
{ 
	unsigned char i,j;
	unsigned int k = 0;
    Delaynms(10);//延时好重要!!!!!!AVR太快了
	Write_char(0,0x36); //图形方式
	Delaynms(10);//延时好重要!!!!!!AVR太快了
	for(i=0;i<32;i++)
  	{ 
		Write_char(0,0x80+i); //列
		Write_char(0,0x80);	  //行
    	for(j=0;j<16;j++) 
		{
			Write_char(1,img[k++]);
		}
  	}

 	for(i=0;i<32;i++)
  	{ 
		Write_char(0,0x80+i);
		Write_char(0,0x88);
    	for(j=0;j<16;j++) 
		{
			Write_char(1,img[k++]);
  		}
	}
}

/******************************************************************************/
void Clr_Scr(void)//清屏函数
{
	Write_char(0,0x01);
}

/******************************************************************************/
void LCD_set_xy( unsigned char x, unsigned char y )
{	//设置LCD显示的起始位置，X为行，Y为列
    unsigned char address;
	switch(x)
	{
		case 0: address = 0x80 + y; break;    
    	case 1: address = 0x80 + y; break; 
		case 2: address = 0x90 + y; break; 
   	 	case 3: address = 0x88 + y; break;
		case 4: address = 0x98 + y; break; 
		default:address = 0x80 + y; break;
	}
    Write_char(0, address);
}

/******************************************************************************/
void LCD_Write_string(unsigned char X,unsigned char Y,unsigned char *s)
{	//	中英文字符串显示函数
	LCD_set_xy( X, Y );   
    while (*s) 
    {
		Write_char( 1, *s );
	    s ++;
		Delaynms(1);
	}
}
/*******************************************************************************/
void LCD_Write_number(unsigned char s)//	数字显示函数
{	
	Write_char(1,num[s]);
	Delaynms(1);
}

void delay(void)          
{    
    unsigned i;
    for(i=0;i<255;i++);
}
/******************************************************************************/
void Lcd_Mark2(void)
{
	Clr_Scr();//清屏
	Delaynms(10);
	LCD_Write_string(1,0,welcome);//
	LCD_Write_string(2,0,input);
}
/******************************************************************************/
 void timer1_init(void)
{
	TCCR1B = 0x00;	//stop timer
	TCNT1H = 0xc7;	//设置 TC1 的 计数寄存器 高8位值
	TCNT1L = 0xc0;	//设置 TC1 的 计数寄存器 低8位值
	TCCR1A = 0x00;
	TCCR1B = 0x04;	//设置TC1 为 CLK/1024分频，启动TC1
	MCUCR  = 0x00;	//设置 MCU 的 控制寄存器
	GICR   = 0x00;  //设置 中断控制寄存器
	TIMSK  = 0x04;	//设置 定时计数器 的 屏蔽寄存器
}   
/******************************************************************************/
void main(void)//主函数
{ 

    DDRA|=1<<0|1<<1|1<<2|0<<7;//设置PA0,PA1,PA2为输出,PA7为输入
	PORTA=0x00;
	
	DDRC|=1<<0;//设置PC0为输出
	PORTC=0x00;

	DDRD|=1<<0;
	PORTD=0x00;
    
	
	Lcd_init();//设置液晶显示器
	Clr_Scr();//清屏	
	Disp_img(logo);	//显示我们的AVR
	Delaynms(40000);//显示画面等待时间
    Lcd_init();
	Lcd_Mark2();
	timer1_init();	
	SEI();	 
    while(1)
	{ 
		  PORTB=discode[disbuf[0]];
          PORTD=0xEF;
          delay();
          PORTD=0xff;
		  PORTB=discode[disbuf[1]];
          PORTD=0xDF;
          delay();
          PORTD=0xff;
		  PORTB=discode[disbuf[2]];      	                     
          PORTD=0xBF;
          delay();
          PORTD=0xff;
	      PORTB=discode[disbuf[3]];
          PORTD=0x7F;
          delay();
          PORTD=0xff;
    }
} //ENDmain
 
#pragma interrupt_handler timer1_ovf_isr:9                    
void timer1_ovf_isr(void) 
		   { 
		         
			     TCNT1H = 0xc7;		//设置 TC1 的 计数寄存器 高8位值
	             TCNT1L = 0xc0;		//设置 TC1 的 计数寄存器 低8位值
				 flag=~flag;
			   
				 
				 Sec++;
				 if(Sec==60)
				  { 
				   Sec=0;
				   Min++;
				        { 
					     if(Min==60)
				  	       { Min=0;
					          Hour++;
						       if(Hour==24)
							    {
						        Hour=0; 
								} 
					       }
						
					    }
					
			       }
			 disbuf[5]=Hour/10;
			 disbuf[4]=Hour%10;
			 disbuf[3]=Min/10;
			 disbuf[2]=Min%10;
			 disbuf[1]=Sec/10;
			 disbuf[0]=Sec%10;
			 LCD_set_xy(1,4);
			 LCD_Write_number(disbuf[5]);
			 LCD_Write_number(disbuf[4]);
			 
			 if(flag==0)
			 {
			 LCD_set_xy(1,5);
			 LCD_Write_number(10);
			 LCD_Write_number(disbuf[3]);
			 LCD_set_xy(1,6);
			 LCD_Write_number(disbuf[2]);
			 LCD_Write_number(10);
			 }
			 else
			 {
			 LCD_set_xy(1,5);
			 LCD_Write_number(11);
			 LCD_Write_number(disbuf[3]);
			 LCD_set_xy(1,6);
			 LCD_Write_number(disbuf[2]);
			 LCD_Write_number(11);
			 }
			
			 LCD_set_xy(1,7);
			 LCD_Write_number(disbuf[1]);
			 LCD_Write_number(disbuf[0]);
			 
			
			 
	}
					 
				 
				