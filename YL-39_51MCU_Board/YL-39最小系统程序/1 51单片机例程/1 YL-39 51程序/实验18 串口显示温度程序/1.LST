C51 COMPILER V9.00   1                                                                     11/16/2011 21:50:00 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE 1
OBJECT MODULE PLACED IN 1.OBJ
COMPILER INVOKED BY: E:\安装软件\keil-51\C51\BIN\C51.EXE 1.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*********************************************************************************
   2          * 【编写时间】： 2011.07.07
   3          * 【作    者】： 雁翎电子
   4          * 【版    本】： V1.0
   5          * 【网    站】： http://ylelectronic.taobao.com/ 
   6          * 【Q      Q】： 348439350
   7          * 【声    明】： 此程序仅用于学习与参考，引用请注明版权和作者信息！
   8          * 【函数功能】： 利用单线制DS18B20温度传感器  串口显示当前的温度值                                                                                  
   9          * 【使用说明】： 波特率：9600 串口数据：温度值整数部分=前一位  温度值小数部分后一位*16
  10          **********************************************************************************/
  11          #include <reg52.h>
  12          #include<math.h>
  13          #include <stdio.h>
  14          #include<intrins.h>
  15          
  16          void delay(unsigned int i);
  17          void delay1ms(unsigned int i);
  18          void ReadTemperature(void);
  19          void Init_DS18B20(void);
  20          ReadOneChar();
  21          void WriteOneChar(unsigned char dat);
  22          
  23          /* 变量定义 -----------------------------------------------*/
  24          sbit DQ=P3^7; //数据传输线接单片机的相应的引脚 
  25          unsigned char tempL=0; //设全局变量
  26          unsigned char tempH=0; 
  27          unsigned int sdate;//测量到的温度的整数部分
  28          unsigned char xiaoshu1;//小数第一位
  29          unsigned char xiaoshu2;//小数第二位
  30          unsigned char xiaoshu;//两位小数
  31          bit  fg=1;        //温度正负标志
  32          unsigned char date;
  33          
  34          //******************************
  35          
  36          //*****串口初始化函数***********
  37          
  38          //******************************
  39          void Initial_com(void)
  40          {
  41   1              SCON=0x50;          //串口选择模式1, 8-bit UART, 使能接收    
  42   1          TMOD|=0x20;     //用定时器1设置波特率
  43   1          TH1=0xFD;     
  44   1          TR1=1;           
  45   1              TI=1;                   //开启串口中断
  46   1      
  47   1      }
  48          
  49           /*
  50          ********************************************************************************
  51          ** 函数名称 ： delay(unsigned char i)
  52          ** 函数功能 ： 延时函数         这个延时程序的具体延时时间是time=i*8+10,适用于小于2ms的延时
  53          ********************************************************************************
  54          */
  55          void delay(unsigned int i)
C51 COMPILER V9.00   1                                                                     11/16/2011 21:50:00 PAGE 2   

  56          {
  57   1              
  58   1              while(i--);
  59   1        
  60   1        
  61   1      }
  62          
  63          /*
  64          ********************************************************************************
  65          ** 函数名称 ：  delay1ms(unsigned char i)
  66          ** 函数功能 ： 延时函数 
  67          ********************************************************************************
  68          */
  69          void delay1ms(unsigned int i)
  70          {
  71   1       for(i=124;i>0;i--);  //延时124*8+10=1002us
  72   1      }
  73          
  74          
  75          /*
  76          ********************************************************************************
  77          ** 函数名称 ： Init_DS18B20(void)
  78          ** 函数功能 ： 初始化
  79          ********************************************************************************
  80          */
  81          void Init_DS18B20(void) 
  82          {
  83   1       unsigned char x=0;
  84   1       DQ=1; //DQ先置高 
  85   1       delay(8); //稍延时
  86   1       DQ=0; //发送复位脉冲 
  87   1       delay(80); //延时（>480us) 
  88   1       DQ=1; //拉高数据线 
  89   1       delay(5); //等待（15~60us) 
  90   1       x=DQ; //用X的值来判断初始化有没有成功，18B20存在的话X=0，否则X=1 
  91   1       delay(20); 
  92   1      } 
  93          
  94          
  95          /*
  96          ********************************************************************************
  97          ** 函数名称 ：  ReadOneChar()
  98          ** 函数功能 ： 读一个字节
  99          ********************************************************************************
 100          */
 101           ReadOneChar()  //主机数据线先从高拉至低电平1us以上，再使数据线升为高电平，从而产生读信号
 102          {
 103   1      unsigned char i=0; //每个读周期最短的持续时间为60us，各个读周期之间必须有1us以上的高电平恢复期
 104   1      unsigned char dat=0; 
 105   1      for (i=8;i>0;i--) //一个字节有8位 
 106   1      {
 107   2       DQ=1; 
 108   2       delay(1); 
 109   2       DQ=0;
 110   2       dat>>=1; 
 111   2       DQ=1; 
 112   2       if(DQ) 
 113   2       dat|=0x80; 
 114   2       delay(4);
 115   2      } 
 116   1      return(dat);
 117   1      } 
C51 COMPILER V9.00   1                                                                     11/16/2011 21:50:00 PAGE 3   

 118          
 119          
 120          /*
 121          ********************************************************************************
 122          ** 函数名称 ： WriteOneChar(unsigned char dat)
 123          ** 函数功能 ： 写一个字节
 124          ********************************************************************************
 125          */
 126          
 127          void WriteOneChar(unsigned char dat) 
 128          { 
 129   1        unsigned char i=0; //数据线从高电平拉至低电平，产生写起始信号。15us之内将所需写的位送到数据线上，
 130   1        for(i=8;i>0;i--) //在15~60us之间对数据线进行采样，如果是高电平就写1，低写0发生。 
 131   1        {
 132   2         DQ=0; //在开始另一个写周期前必须有1us以上的高电平恢复期。 
 133   2         DQ=dat&0x01; 
 134   2         delay(5); 
 135   2         DQ=1; 
 136   2         dat>>=1;
 137   2        } 
 138   1        delay(4);
 139   1      } 
 140          
 141          
 142          /*
 143          ********************************************************************************
 144          ** 函数名称 ： ReadTemperature(void)
 145          ** 函数功能 ： 读温度值（低位放tempL;高位放tempH;）
 146          ********************************************************************************
 147          */
 148          
 149          void ReadTemperature(void) 
 150          { 
 151   1       Init_DS18B20(); //初始化
 152   1       WriteOneChar(0xcc); //跳过读序列号的操作
 153   1       WriteOneChar(0x44); //启动温度转换
 154   1       delay(125); //转换需要一点时间，延时 
 155   1       Init_DS18B20(); //初始化
 156   1       WriteOneChar(0xcc); //跳过读序列号的操作 
 157   1       WriteOneChar(0xbe); //读温度寄存器（头两个值分别为温度的低位和高位） 
 158   1       tempL=ReadOneChar(); //读出温度的低位LSB
 159   1       tempH=ReadOneChar(); //读出温度的高位MSB 
 160   1        
 161   1                      if(tempH>0x7f)      //最高位为1时温度是负
 162   1                      {
 163   2                       tempL=~tempL;         //补码转换，取反加一
 164   2                       tempH=~tempH+1;       
 165   2                       fg=0;      //读取温度为负时fg=0
 166   2             }
 167   1                 sdate = tempL/16+tempH*16;      //整数部分
 168   1                 xiaoshu1 = (tempL&0x0f)*10/16; //小数第一位
 169   1                 xiaoshu2 = (tempL&0x0f)*100/16%10;//小数第二位
 170   1                 xiaoshu=xiaoshu1*10+xiaoshu2; //小数两位
 171   1                      
 172   1                      
 173   1      
 174   1      }
 175          
 176          
 177          //*************************
 178          //**********主函数*********
 179          //*************************
C51 COMPILER V9.00   1                                                                     11/16/2011 21:50:00 PAGE 4   

 180          main()
 181          {
 182   1               Initial_com();
 183   1               while(1)
 184   1               {
 185   2                       ReadTemperature();
 186   2                       
 187   2                       SBUF=sdate;
 188   2                       delay1ms(50000);
 189   2                       delay1ms(50000);
 190   2                       delay1ms(50000);
 191   2                       delay1ms(50000);
 192   2                       SBUF=xiaoshu;
 193   2                       delay1ms(50000);
 194   2                       delay1ms(50000);
 195   2                       delay1ms(50000);
 196   2                       delay1ms(50000);                                       
 197   2                }
 198   1      }
 199          
 200          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    341    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
